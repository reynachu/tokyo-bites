<turbo-frame id="main_content">
  <div class="container my-5">

    <!-- Header: compact on mobile -->
    <div class="mb-3 mb-md-4">

      <% primary_photo = @restaurant.photos.attached? ? @restaurant.photos.first : nil %>

      <!-- MOBILE: compact media card (shown < md) -->
      <div class="d-md-none">
        <div class="card shadow-sm border-0 compact-header">
          <div class="card-body py-3">
            <div class="d-flex gap-3 align-items-start">
              <!-- <div class="flex-shrink-0">
                <% if primary_photo %>
                  <%= image_tag primary_photo, class: "rounded object-cover", style: "width:84px; height:84px;" %>
                <% else %>
                  <%= image_tag "default_avatar.png", class: "rounded object-cover", style: "width:84px; height:84px;" %>
                <% end %>
              </div> -->

              <div class="flex-grow-1 min-w-0">
                <h2 class="h5 fw-bold mb-1 text-truncate"><%= @restaurant.name %></h2>

                <!-- actions -->
               <div class="d-flex gap-2 mt-2 flex-wrap">
                  <%= link_to new_recommendation_path(
                                restaurant_id: @restaurant.id,
                                restaurant_name: @restaurant.name
                              ),
                              class: "btn btn-recommend btn-sm rounded-pill px-3 py-1
                                d-inline-flex align-items-center justify-content-center" ,
                              data: { turbo_frame: "main_content", turbo_action: 'advance'} do %>
                    Recommend
                  <% end %>

                  <% if user_signed_in? %>
                    <% saved = Bookmark.find_by(user: current_user, restaurant: @restaurant).present? %>
                  <button
                      type="button"
                      class="bookmark-btn d-flex align-items-center justify-content-center p-2 border-0 bg-transparent"
                      aria-label="<%= saved ? "Remove bookmark" : "Add bookmark" %>"
                      aria-pressed="<%= saved %>"
                      data-controller="bookmark"
                      data-bookmark-restaurantid-value="<%= @restaurant.id %>"
                      data-action="click->bookmark#<%= saved ? "deleteBookmark" : "addBookmark" %>">
                      <i class="fa-bookmark <%= saved ? "fa-solid" : "fa-regular" %> fa-lg"></i>
                    </button>
                  <% else %>
                    <%= link_to "Sign in to bookmark this restaurant", new_user_session_path, class: "small text-decoration-none text-primary" %>
                  <% end %>
                </div>


                <!-- collapsible details to avoid vertical sprawl -->
                <div class="mt-2">
                  <a class="small text-decoration-none d-inline-flex align-items-center gap-1 collapsed collapse-toggle"
                    data-bs-toggle="collapse"
                    href="#hdrDetails"
                    role="button"
                    aria-expanded="false"
                    aria-controls="hdrDetails">
                    <i class="bi bi-chevron-down chev"></i>
                    <span>Details</span>
                  </a>

                  <div class="collapse mt-2" id="hdrDetails">
                    <div class="text-muted small">
                      <div class="mb-1">
                        <i class="bi bi-tag-fill me-1"></i>
                        <%= @restaurant.category.presence || "‚Äî" %>
                      </div>
                      <div class="text-truncate mb-1">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        <%= @restaurant.address.presence || "‚Äî" %>
                      </div>
                      <div>
                        <i class="bi bi-clock-fill me-1"></i>
                        <span><%= @restaurant.opening_hours.presence || "‚Äî" %></span>
                      </div>
                    </div>
                  </div>
                </div>


              </div><!-- /grow -->
            </div>
          </div>
        </div>
      </div>

      <!-- DESKTOP/TABLET: -->
      <div class="row g-4 align-items-start mb-0 d-none d-md-flex">
        <!-- <div class="col-md-4">
          <% if primary_photo %>
            <%= image_tag primary_photo,
                  class: "img-fluid rounded shadow-sm w-100 object-cover-md",
                  style: "height: 220px; object-fit: cover;" %>
          <% else %>
            <%= image_tag "default_avatar.png",
                  class: "img-fluid rounded shadow-sm w-100 object-cover-md",
                  style: "height: 220px; object-fit: cover;" %>
          <% end %>
        </div> -->

        <div class="col-md-8">
          <div class="d-flex justify-content-between align-items-start">
            <h1 class="fw-bold mb-2 h3"><%= @restaurant.name %></h1>
          </div>

          <dl class="row text-muted mb-0">
            <dt class="col-sm-3"><i class="bi bi-tag-fill me-1"></i> category:</dt>
            <dd class="col-sm-9"><%= @restaurant.category.presence || "‚Äî" %></dd>

            <dt class="col-sm-3"><i class="bi bi-geo-alt-fill me-1"></i> address:</dt>
            <dd class="col-sm-9"><%= @restaurant.address.presence || "‚Äî" %></dd>

            <dt class="col-sm-3"><i class="bi bi-clock-fill me-1"></i> opening hours:</dt>
            <dd class="col-sm-9"><%= @restaurant.opening_hours.presence || "‚Äî" %></dd>
          </dl>

          <div class="mt-3 d-flex gap-2">
            <%= link_to new_recommendation_path(
                          restaurant_id: @restaurant.id,
                          restaurant_name: @restaurant.name
                        ),
                        class: "btn btn-recommend rounded-pill px-3 py-2 d-flex justify-content-center align-items-center gap-1",
                        data: { turbo_frame: "main_content", turbo_action: 'advance' } do %>
              <i class="bi bi-stars"></i><span>Recommend</span>
            <% end %>

            <% if user_signed_in? %>
              <% saved = Bookmark.find_by(user: current_user, restaurant: @restaurant).present? %>
            <button
                type="button"
                class="bookmark-btn d-flex align-items-center justify-content-center p-2 border-0 bg-transparent"
                aria-label="<%= saved ? "Remove bookmark" : "Add bookmark" %>"
                aria-pressed="<%= saved %>"
                data-controller="bookmark"
                data-bookmark-restaurantid-value="<%= @restaurant.id %>"
                data-action="click->bookmark#<%= saved ? "deleteBookmark" : "addBookmark" %>">
                <i class="fa-bookmark <%= saved ? "fa-solid" : "fa-regular" %> fa-lg"></i>
              </button>
            <% else %>
              <%= link_to "Sign in to bookmark this restaurant", new_user_session_path, class: "small text-decoration-none text-primary" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>



    <style>
      :root{
        --brand-bg: #faf1e8;
        --brand-accent: #c72b17;
      }
      .btn-recommend{
        background-color: var(--brand-accent);
        color:#fff; border:0;
        padding:.45rem .9rem;
        box-shadow: 0 6px 14px rgba(199,43,23,.18);
      }
      .btn-recommend:hover{ background-color:#a62213; color:#fff; }
      .btn-recommend:focus-visible{ outline:0; box-shadow:0 0 0 .2rem rgba(199,43,23,.35); }
      .btn-recommend:active{ background-color:#8d1c10; }

      /* Mobile-first tightening */
      .container.my-5 { margin-top: 1rem !important; margin-bottom: 1rem !important; }
      @media (min-width: 768px){
        .container.my-5 { margin-top: 3rem !important; margin-bottom: 3rem !important; }
      }

      .compact-header .object-cover { object-fit: cover; }
      .compact-header .text-truncate { max-width: 100%; }

      /* >>> Updated button rules (full text, no icon sizing) */
      .compact-header .btn {
        font-size: 0.875rem;
        padding: 0.4rem 0.9rem;
        line-height: 1.2;
        min-height: 36px;          /* comfy touch target */
        white-space: nowrap;        /* keep label on one line */
      }
      .compact-header form {        /* button_to wraps a form; keep it inline so flex works */
        display: inline-flex;
        margin-bottom: 0;
      }

      /* optional: allow wrap when it truly doesn't fit */
      .compact-header .d-flex.flex-wrap .btn {
        flex: 0 1 auto;
        min-width: 110px;
      }

      /* Make the HR slimmer to save some fold space on mobile */
      @media (max-width: 767.98px){
        hr.my-4 { margin: .75rem 0 !important; }
      }

      /* Center labels/icons inside buttons perfectly */
      .compact-header .btn,
      .btn-recommend {
        display: inline-flex;           /* switch from inline-block */
        align-items: center;            /* vertical center */
        justify-content: center;        /* horizontal center */
        line-height: 1;                 /* remove baseline weirdness */
      }

      /* Keep your comfy touch target on mobile buttons */
      .compact-header .btn {
        min-height: 36px;
        font-size: 0.875rem;
        padding: 0.4rem 0.9rem;
        white-space: nowrap;
      }

      /* Desktop Recommend button: reduce icon spacing slightly for visual balance */
      @media (min-width: 768px){
        .btn-recommend.gap-2 { gap: .25rem !important; } /* turns gap-2 ‚âà 0.5rem into ~0.25rem */
      }

      .collapse-toggle .chev { transition: transform .18s ease; }
      .collapse-toggle:not(.collapsed) .chev { transform: rotate(180deg); }
    </style>

    <hr class="my-4">

    <!-- Body: timeline left, map right -->
    <div class="row g-4">
      <!-- LEFT: scrollable mini timeline (same height, smaller cards) -->
      <div class="col-lg-7">
        <h3 class="mb-3">üçΩ Recommendations</h3>

        <% if @recommendations.present? %>
          <div class="rounded border bg-body overflow-auto mini-timeline" style="max-height: 65vh;">
            <div class="p-2 d-flex flex-column gap-2">
              <%= render partial: "recommendations/recommendation_card",
                        collection: @recommendations,
                        as: :recommendation,
                        locals: { compact: true } %>
            </div>
          </div>
        <% else %>
          <p class="text-muted fst-italic mb-0">No recommendations yet.</p>
        <% end %>
      </div>

     <style>
        /* shrink card chrome without editing the partial */
        .mini-timeline .card          { margin-bottom: .25rem !important; box-shadow: var(--bs-box-shadow-sm); }
        .mini-timeline .card-body     { padding: .5rem .6rem !important; }
        .mini-timeline .rounded-circle{ width: 28px !important; height: 28px !important; }

        /* shorter media area (works for any .ratio inside the card, including carousel slides) */
        .mini-timeline .ratio         { --bs-aspect-ratio: 42%; } /* tweak: 38‚Äì48% */
        .mini-timeline .carousel .ratio { --bs-aspect-ratio: 42%; }

        /* typography tightening */
        .mini-timeline .card p,
        .mini-timeline .card .small,
        .mini-timeline .card .text-muted,
        .mini-timeline .card .badge   { font-size: .85rem !important; }


        /* optional: clamp long descriptions to 3 lines */
        .mini-timeline .card p {
          margin-bottom: .35rem;
          display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
          overflow: hidden;
        }
      </style>

      <!-- RIGHT: Map -->
      <div class="col-lg-5">
        <!-- <h3 class="mb-3">üó∫ Map</h3> -->
        <div
          data-controller="map"
          data-map-markers-value='<%= @markers.to_json %>'
          data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
          class="rounded shadow-sm" style="height: 350px;">
        </div>
      </div>
    </div>

  </div>
</turbo-frame>
